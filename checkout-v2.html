<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finalizar Pedido</title>
  <style>
    :root {
      --pink: #ff2d55;
      --pink-dark: #e02649;
      --gray-text: #1f2328;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #f3f4f6; overflow-x: hidden; }
    .app {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: #fff;
      min-height: 100dvh;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header { display:flex; align-items:center; gap:12px; padding: 14px 12px; border-bottom:1px solid #eef0f3; background:#fff; }
    .back-btn { width:32px; height:32px; display:grid; place-items:center; background:transparent; border:0; color:#111; cursor:pointer; }
    .header-title { font-weight:700; font-size:16px; color:var(--gray-text); }

    /* Content */
    .content { flex:1; padding:16px 12px 100px; }
    .section-title { font-weight:800; font-size:18px; color:var(--gray-text); text-align:center; margin-bottom:20px; }

    /* Product summary */
    .product-summary { display:flex; gap:12px; padding:12px; background:#fff; border:1px solid #eef0f3; border-radius:12px; margin-bottom:20px; }
    .product-img { width:80px; height:80px; border-radius:8px; object-fit:cover; background:#f6f7f9; }
    .product-info { flex:1; }
    .product-name { font-size:14px; color:var(--gray-text); line-height:1.3; margin-bottom:8px; }
    .product-price { font-weight:800; font-size:18px; color:var(--pink); }
    .product-unit { font-size:13px; color:#6b7280; }

    /* Quantity */
    .quantity-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .quantity-label { font-weight:600; color:var(--gray-text); }
    .quantity-controls { display:flex; align-items:center; gap:12px; }
    .qty-btn { width:32px; height:32px; border:1px solid #e7e9ec; background:#fff; border-radius:6px; font-size:18px; cursor:pointer; }
    .qty-value { font-weight:600; min-width:30px; text-align:center; }

    /* Subtotal */
    .subtotal-row { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #eef0f3; margin-bottom:20px; }
    .subtotal-label { color:#6b7280; }
    .subtotal-value { font-weight:700; font-size:16px; color:var(--gray-text); }

    /* Form */
    .form-section { margin-bottom:24px; }
    .form-title { font-weight:400; font-size:14px; color:#6b7280; margin-bottom:12px; }
    .form-group { margin-bottom:16px; }
    .form-label { display:block; font-size:14px; font-weight:600; color:var(--gray-text); margin-bottom:6px; }
    .form-label .required { color:var(--pink); }
    .form-input { width:100%; padding:12px; border:1px solid #e7e9ec; border-radius:8px; font-size:14px; }
    .form-input:focus { outline:none; border-color:var(--pink); }
    .form-input:disabled { background:#f6f7f9; color:#9aa1a9; cursor:not-allowed; }
    .form-input.error { border-color:#ef4444; }
    .form-input.success { border-color:#10b981; }
    .form-error { color:#ef4444; font-size:12px; margin-top:4px; display:none; }
    .form-error.show { display:block; }
    .form-loading { color:#6b7280; font-size:12px; margin-top:4px; display:none; }
    .form-loading.show { display:block; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

    /* Shipping options */
    .shipping-section { margin-bottom:24px; }
    .shipping-option { display:flex; align-items:center; gap:12px; padding:14px; border:2px solid #e7e9ec; border-radius:12px; margin-bottom:12px; cursor:pointer; transition:all 0.2s; }
    .shipping-option:hover { border-color:#d1d5db; }
    .shipping-option.selected { border-color:var(--pink); background:#fff0f3; }
    .shipping-radio { width:20px; height:20px; border:2px solid #d1d5db; border-radius:50%; position:relative; flex:0 0 auto; }
    .shipping-option.selected .shipping-radio { border-color:var(--pink); }
    .shipping-option.selected .shipping-radio::after { content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:10px; height:10px; background:var(--pink); border-radius:50%; }
    .shipping-icon { width:24px; height:24px; color:#6b7280; flex:0 0 auto; }
    .shipping-details { flex:1; }
    .shipping-name { font-weight:700; font-size:14px; color:var(--gray-text); margin-bottom:2px; display:flex; align-items:center; overflow:visible; }
    .shipping-time { font-size:13px; color:#6b7280; }
    .shipping-price { font-weight:700; font-size:16px; color:#10b981; flex:0 0 auto; }
    .shipping-price.paid { color:var(--gray-text); }

    /* Total */
    .total-section { padding:16px 0; border-top:1px solid #eef0f3; margin-bottom:20px; }
    .total-row { display:flex; justify-content:space-between; align-items:center; }
    .total-label { font-weight:700; font-size:16px; color:var(--gray-text); }
    .total-value { font-weight:800; font-size:22px; color:var(--pink); }

    /* Footer buttons */
    .footer-buttons { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:420px; background:#fff; border-top:1px solid #eef0f3; padding:12px; display:flex; gap:12px; }
    .btn { flex:1; height:48px; border:0; border-radius:12px; font-weight:700; font-size:15px; cursor:pointer; }
    .btn-back { background:#f1f2f4; color:var(--gray-text); }
    .btn-continue { background:var(--pink); color:#fff; }
    .btn-continue:active { background:var(--pink-dark); }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <button class="back-btn" onclick="history.back()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </button>
      <h1 class="header-title">Finalizar Pedido</h1>
    </header>

    <main class="content">
      <h2 class="section-title">Finalizar Pedido</h2>

      <div class="product-summary">
        <img class="product-img" id="checkout-product-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect fill='%23f6f7f9' width='80' height='80'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%239aa1a9' font-size='12'%3ESem imagem%3C/text%3E%3C/svg%3E" alt="Produto" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Crect fill=\'%23f6f7f9\' width=\'80\' height=\'80\'/%3E%3C/svg%3E'" />
        <div class="product-info">
          <div class="product-name" id="checkout-product-name">Patinete El√©trico Scooter Para Adultos 350W Capacidade de Carga de 150KG</div>
          <div>
            <span class="product-price" id="checkout-product-price">R$ 10,99</span>
            <span class="product-unit">/unidade</span>
          </div>
        </div>
      </div>

      <div class="quantity-row">
        <span class="quantity-label">Quantidade:</span>
        <div class="quantity-controls">
          <button class="qty-btn" onclick="decreaseQty()">‚àí</button>
          <span class="qty-value" id="qty-value">1</span>
          <button class="qty-btn" onclick="increaseQty()">+</button>
        </div>
      </div>

      <div class="subtotal-row">
        <span class="subtotal-label">Subtotal (1 item):</span>
        <span class="subtotal-value" id="subtotal-value">R$ 10,99</span>
      </div>

      <div class="form-section">
        <h3 class="form-title">Dados Pessoais</h3>
        <div class="form-group">
          <label class="form-label">Nome Completo <span class="required">*</span></label>
          <input type="text" id="nome" class="form-input" placeholder="Seu nome completo" />
        </div>
        <div class="form-group">
          <label class="form-label">E-mail <span class="required">*</span></label>
          <input type="email" id="email" class="form-input" placeholder="seu@email.com" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Telefone <span class="required">*</span></label>
            <input type="tel" id="telefone" class="form-input" placeholder="(00) 00000-0000" />
          </div>
          <div class="form-group">
            <label class="form-label">CPF <span class="required">*</span></label>
            <input type="text" id="cpf" class="form-input" placeholder="000.000.000-00" />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="form-title">Endere√ßo de Entrega</h3>
        <div class="form-group">
          <label class="form-label">CEP <span class="required">*</span></label>
          <input type="text" id="cep" class="form-input" placeholder="00000-000" maxlength="9" />
          <div class="form-error" id="cep-error">CEP inv√°lido</div>
          <div class="form-loading" id="cep-loading">Buscando endere√ßo...</div>
        </div>
        <div class="form-group">
          <label class="form-label">Endere√ßo <span class="required">*</span></label>
          <input type="text" id="endereco" class="form-input" placeholder="Rua, avenida..." />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">N√∫mero <span class="required">*</span></label>
            <input type="text" id="numero" class="form-input" placeholder="123" />
          </div>
          <div class="form-group">
            <label class="form-label">Complemento</label>
            <input type="text" id="complemento" class="form-input" placeholder="Apto, bloco..." />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Bairro <span class="required">*</span></label>
            <input type="text" id="bairro" class="form-input" placeholder="Bairro" />
          </div>
          <div class="form-group">
            <label class="form-label">Cidade <span class="required">*</span></label>
            <input type="text" id="cidade" class="form-input" placeholder="Cidade" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Estado <span class="required">*</span></label>
          <input type="text" id="estado" class="form-input" placeholder="UF" maxlength="2" />
        </div>
      </div>

      <div class="shipping-section">
        <h3 class="form-title">Escolha uma forma de entrega:</h3>
        <div class="shipping-option selected" onclick="selectShipping(this, 0)">
          <div class="shipping-radio"></div>
          <div class="shipping-details">
            <div class="shipping-name">
              Correios - PAC
              <img src="images/correios-logo.svg" alt="Correios" style="width:100px;height:auto;margin-left:8px;vertical-align:middle;" />
            </div>
            <div class="shipping-time">de 5 at√© 7 dias</div>
          </div>
          <div class="shipping-price">Gr√°tis</div>
        </div>
        <div class="shipping-option" onclick="selectShipping(this, 11.25)">
          <div class="shipping-radio"></div>
          <div class="shipping-details">
            <div class="shipping-name">
              Sedex - EXPRESS
              <img src="images/sedex-full-logo.svg" alt="Sedex Full" style="width:80px;height:auto;margin-left:8px;vertical-align:middle;" />
            </div>
            <div class="shipping-time">de 2 at√© 4 dias</div>
          </div>
          <div class="shipping-price paid">R$ 11,25</div>
        </div>
      </div>

      <div class="total-section">
        <div class="total-row">
          <span class="total-label">Total com Frete:</span>
          <span class="total-value" id="total-value">R$ 10,99</span>
        </div>
      </div>
    </main>

    <div class="footer-buttons">
      <button class="btn btn-back" onclick="history.back()">Voltar</button>
      <button class="btn btn-continue" onclick="goToPayment(event)">Continuar para Pagamento</button>
    </div>
  </div>

  <script>
    let qty = 1;
    let basePrice = 10.99; // Alterado para R$ 10,99
    let shippingCost = 0;

    function formatBRL(value) {
      return value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function updateTotal() {
      const subtotal = basePrice * qty;
      const total = subtotal + shippingCost;
      
      document.getElementById('subtotal-value').textContent = 'R$ ' + formatBRL(subtotal);
      document.getElementById('total-value').textContent = 'R$ ' + formatBRL(total);
      document.querySelector('.subtotal-label').textContent = `Subtotal (${qty} item${qty > 1 ? 's' : ''}):`;
    }

    function selectShipping(element, cost) {
      // Remove selected from all options
      document.querySelectorAll('.shipping-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      // Add selected to clicked option
      element.classList.add('selected');
      // Update shipping cost and total
      shippingCost = cost;
      updateTotal();
    }

    function increaseQty() {
      qty++;
      document.getElementById('qty-value').textContent = qty;
      updateTotal();
    }

    function decreaseQty() {
      if (qty > 1) {
        qty--;
        document.getElementById('qty-value').textContent = qty;
        updateTotal();
      }
    }

    // Helper function to get product ID from URL
    function getCurrentProductId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('produto');
    }
    
    // Load product data from admin
    function loadProductData() {
      const productId = getCurrentProductId();
      let productData;
      
      if (productId) {
        // Try to find product in all_products array
        const allProductsData = localStorage.getItem('all_products');
        if (allProductsData) {
          const allProducts = JSON.parse(allProductsData);
          const product = allProducts.find(p => p.id == productId);
          if (product) {
            productData = JSON.stringify(product);
          }
        }
      }
      
      // Fallback to default
      if (!productData) {
        productData = localStorage.getItem('product_data');
      }
      console.log('Loading product data:', productData); // Debug
      
      if (productData) {
        const data = JSON.parse(productData);
        console.log('Parsed data:', data); // Debug
        
        // Update product name
        if (data.name) {
          document.getElementById('checkout-product-name').textContent = data.name;
        }
        
        // Update price
        if (data.price) {
          basePrice = data.price;
          const priceFormatted = formatBRL(data.price);
          document.getElementById('checkout-product-price').textContent = 'R$ ' + priceFormatted;
          updateTotal();
        }
        
        // Update image - check images array first, then single image
        console.log('Images array:', data.images); // Debug
        console.log('Single image:', data.image); // Debug
        
        if (data.images && data.images.length > 0) {
          console.log('Loading from images array'); // Debug
          window.PRODUCT_IMAGE_URL = data.images[0];
          const imgElement = document.getElementById('checkout-product-img');
          if (imgElement) imgElement.src = data.images[0];
        } else if (data.image) {
          console.log('Loading from single image'); // Debug
          window.PRODUCT_IMAGE_URL = data.image;
          const imgElement = document.getElementById('checkout-product-img');
          if (imgElement) imgElement.src = data.image;
        } else {
          console.log('No image found!'); // Debug
        }
      } else {
        console.log('No product_data in localStorage'); // Debug
      }
    }
    
    // Ensure DOM is loaded before running
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadProductData);
    } else {
      loadProductData();
    }

    // Load product image if available (fallback)
    window.addEventListener('load', function() {
      const productImg = window.PRODUCT_IMAGE_URL || '';
      if (productImg && !localStorage.getItem('product_data')) {
        const imgEl = document.getElementById('checkout-product-img');
        if (imgEl) imgEl.src = productImg;
      }
    });

    // Fun√ß√£o para verificar se o backend Node.js est√° dispon√≠vel
    async function checkBackendAvailable() {
      try {
        console.log('üîç Verificando backend...');
        
        // Tentar endpoint de health check primeiro
        const response = await fetch('/health', { 
          method: 'GET',
          cache: 'no-cache',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        console.log('üìä Status do backend:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Backend online:', data.message);
          return true;
        }
        
        // Fallback: tentar /api/pagar com HEAD
        const fallbackResponse = await fetch('/api/pagar', { 
          method: 'HEAD',
          cache: 'no-cache'
        });
        
        // Qualquer resposta diferente de erro de rede significa que o servidor est√° l√°
        const isOnline = fallbackResponse.status < 500;
        console.log(isOnline ? '‚úÖ Backend dispon√≠vel (fallback)' : '‚ùå Backend offline');
        return isOnline;
        
      } catch (error) {
        // Se der erro de rede, significa que n√£o tem servidor Node.js rodando
        console.error('‚ùå Backend Node.js n√£o encontrado:', error.message);
        return false;
      }
    }

    async function goToPayment(event) {
      console.log('ÔøΩ CHECKOUT VERSION: 2024-11-06 v2 - CORRETO');
      
      // Prevent default form submission if called from form
      if (event && event.preventDefault) {
        event.preventDefault();
      }
      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const cep = document.getElementById('cep').value.trim();
      const endereco = document.getElementById('endereco').value.trim();
      const numero = document.getElementById('numero').value.trim();
      const bairro = document.getElementById('bairro').value.trim();
      const cidade = document.getElementById('cidade').value.trim();
      const estado = document.getElementById('estado').value.trim();

      if (!nome || !email || !telefone || !cpf || !cep || !endereco || !numero || !bairro || !cidade || !estado) {
        alert('‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios!');
        return;
      }

      const total = basePrice * qty + shippingCost;
      const totalFormatted = formatBRL(total);
      const shipping = shippingCost === 0 ? 'Gr√°tis' : 'R$ ' + formatBRL(shippingCost);

      // Verificar se gateway est√° configurado
      const gatewayConfig = localStorage.getItem('gateway_config');
      console.log('üîç Gateway config:', gatewayConfig ? 'Configurado' : 'N√£o configurado');
      
      if (gatewayConfig) {
        // Detectar qual gateway est√° configurado
        const config = JSON.parse(gatewayConfig);
        const gatewayName = config.provider === 'custom' ? 'IronPay (Custom)' : config.provider?.toUpperCase() || 'Desconhecido';
        console.log(`‚úÖ Usando Gateway: ${gatewayName}`);
        
        // Encontrar o bot√£o
        const btn = event?.target || document.querySelector('button[onclick*="goToPayment"]');
        const originalText = btn ? btn.textContent : '';
        
        try {
          if (btn) {
            btn.textContent = '‚è≥ Gerando pagamento...';
            btn.disabled = true;
          }

          console.log('üîÑ Inicializando gateway...');
          
          // Verificar se PaymentGateway existe
          if (typeof PaymentGateway === 'undefined') {
            throw new Error('M√≥dulo PaymentGateway n√£o carregado. Verifique se o script js/payment-gateway.js est√° inclu√≠do.');
          }
          
          // Preparar dados do produto
          const productId = getCurrentProductId();
          let productDataStr;
          
          if (productId) {
            // Try to find product in all_products array
            const allProductsData = localStorage.getItem('all_products');
            if (allProductsData) {
              const allProducts = JSON.parse(allProductsData);
              const product = allProducts.find(p => p.id == productId);
              if (product) {
                // Merge with current product_data to get images
                const currentData = localStorage.getItem('product_data');
                if (currentData) {
                  const current = JSON.parse(currentData);
                  if (current.id == productId && current.images) {
                    product.images = current.images;
                  }
                }
                productDataStr = JSON.stringify(product);
              }
            }
          }
          
          // Fallback to default
          if (!productDataStr) {
            productDataStr = localStorage.getItem('product_data');
          }
          
          const productData = JSON.parse(productDataStr || '{}');
          
          console.log('\nüîç ==== DEBUG - DADOS DO PRODUTO ====');
          console.log('product_data completo:', JSON.stringify(productData, null, 2));
          console.log('productData.ironpay existe?', productData.ironpay ? 'SIM' : 'N√ÉO');
          if (productData.ironpay) {
            console.log('productData.ironpay:', JSON.stringify(productData.ironpay, null, 2));
          }
          
          // Obter token do gateway configurado (opcional - servidor pode ter token fixo)
          const gatewayConfig = JSON.parse(localStorage.getItem('gateway_config') || '{}');
          const apiKey = gatewayConfig.apiKey || null;
          
          console.log('\nüîç ==== DEBUG - GATEWAY CONFIG ====');
          console.log('gateway_config existe?', gatewayConfig ? 'SIM' : 'N√ÉO');
          console.log('gatewayConfig.offerHash:', gatewayConfig.offerHash || 'AUSENTE');
          console.log('gatewayConfig.productHash:', gatewayConfig.productHash || 'AUSENTE');
          console.log('gatewayConfig.apiKey existe?', apiKey ? 'SIM' : 'N√ÉO');
          
          // Gerar PIX via backend
          console.log('\nüí≥ Gerando PIX via backend...');
          
          // Obter hashes espec√≠ficos deste produto (IronPay)
          // IMPORTANTE: Cada produto tem seus pr√≥prios hashes configurados no painel admin
          const offerHash = productData.ironpay?.offerHash || gatewayConfig.offerHash || null;
          const productHash = productData.ironpay?.productHash || gatewayConfig.productHash || null;
          
          console.log('üìù Dados da requisi√ß√£o:');
          console.log('   Produto:', productData.name);
          console.log('   Offer Hash:', offerHash || '‚ö†Ô∏è N√ÉO CONFIGURADO - Configure no painel admin');
          console.log('   Product Hash:', productHash || '‚ö†Ô∏è N√ÉO CONFIGURADO - Configure no painel admin');
          console.log('   Token API presente?', apiKey ? 'SIM' : 'N√ÉO (servidor usar√° env)');
          
          // Validar hashes (aviso se n√£o configurados)
          if (!offerHash || !productHash) {
            console.warn('‚ö†Ô∏è ATEN√á√ÉO: Hashes IronPay n√£o configurados para este produto!');
            console.warn('Configure os hashes no Painel Admin ‚Üí Produto ‚Üí Integra√ß√£o IronPay');
          }
          
          // Detectar se o backend est√° dispon√≠vel
          const backendURL = await checkBackendAvailable() 
            ? '/api/pagar' 
            : null;
          
          if (!backendURL) {
            console.warn('‚ö†Ô∏è Backend n√£o dispon√≠vel. Usando modo direto (apenas para testes).');
            // Modo de fallback - voc√™ precisar√° implementar l√≥gica alternativa aqui
            // Por exemplo: redirecionar para p√°gina de PIX manual
            alert('‚ö†Ô∏è Sistema em modo limitado. Configure o gateway ou use VPS.');
            window.location.href = `pagamento.html?total=R$ ${totalFormatted}&shipping=${shipping}&qty=${qty}&mode=manual`;
            return;
          }
          
          const response = await fetch(backendURL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              amount: Math.round(total * 100), // Converter para centavos
              description: `Compra: ${productData.name || 'Produto'} - Loja Online`, // Descri√ß√£o profissional
              apiKey: apiKey, // Pode ser null - servidor usa env
              offerHash: offerHash, // Hash da oferta (IronPay)
              productHash: productHash, // Hash do produto (IronPay)
              cart: [
                {
                  product_hash: productHash,
                  title: productData.name || 'Produto',
                  cover: null,
                  price: Math.round(total * 100),
                  quantity: qty,
                  operation_type: 1,
                  tangible: false
                }
              ],
              customer: {
                name: nome.trim(), // Remover espa√ßos extras
                email: email.trim().toLowerCase(), // Email padronizado
                phone: telefone.replace(/\D/g, ''), // Apenas n√∫meros
                document: cpf.replace(/\D/g, ''), // CPF limpo
                address: {
                  street: endereco.trim(),
                  number: numero.trim(),
                  complement: document.getElementById('complemento')?.value.trim() || '',
                  neighborhood: bairro.trim(),
                  city: cidade.trim(),
                  state: estado.trim(),
                  zipCode: cep.replace(/\D/g, '')
                }
              }
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Erro ao gerar PIX');
          }
          
          const rawPixData = await response.json();
          
          // Normalizar resposta para formato esperado
          const pixData = {
            transactionId: rawPixData.transaction_id || rawPixData.hash || rawPixData.id,
            hash: rawPixData.hash,
            pixCode: rawPixData.pix_code || rawPixData.qr_code,
            // Mapear ambos qr_code_base64 e qr_code_url
            qr_code_base64: rawPixData.qr_code_base64,
            qr_code_url: rawPixData.qr_code_url,
            qrcodeUrl: rawPixData.qr_code_base64 || rawPixData.qr_code_url,
            status: rawPixData.status,
            amount: rawPixData.amount,
            expiresAt: rawPixData.expires_at,
            payment_url: rawPixData.payment_url
          };

          console.log('‚úÖ PIX gerado com sucesso:', pixData);
          console.log('üîç pixData.transactionId:', pixData.transactionId);
          console.log('üîç pixData.hash:', pixData.hash);
          console.log('üîç pixData.pixCode:', pixData.pixCode ? pixData.pixCode.substring(0, 30) + '...' : 'AUSENTE');
          console.log('üîç pixData.qr_code_base64:', pixData.qr_code_base64 ? 'PRESENTE' : 'AUSENTE');
          console.log('üîç pixData.qr_code_url:', pixData.qr_code_url ? 'PRESENTE' : 'AUSENTE');
          console.log('üîç pixData.qrcodeUrl:', pixData.qrcodeUrl ? 'PRESENTE' : 'AUSENTE');
          
          // Validar dados antes de salvar
          if (!pixData || !pixData.transactionId) {
            throw new Error('Dados do PIX inv√°lidos. Transaction ID n√£o encontrado.');
          }
          
          // Salvar dados do pagamento
          const paymentData = JSON.stringify(pixData);
          console.log('üíæ Salvando no localStorage:', paymentData.substring(0, 100) + '...');
          localStorage.setItem('current_payment', paymentData);
          
          // Verificar se salvou
          const saved = localStorage.getItem('current_payment');
          console.log('‚úÖ Verificado - Dados salvos:', saved ? 'SIM' : 'N√ÉO');
          
          // Redirecionar para p√°gina de pagamento
          const redirectUrl = `pagamento.html?total=R$ ${totalFormatted}&shipping=${shipping}&qty=${qty}&txid=${pixData.transactionId}`;
          console.log('üîÄ Redirecionando para:', redirectUrl);
          
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 500);
          
        } catch (error) {
          console.error('‚ùå Erro ao gerar PIX:', error);
          alert('‚ùå Erro ao gerar pagamento: ' + error.message + '\n\nVerifique a configura√ß√£o do Gateway no admin.');
          
          if (btn) {
            btn.textContent = originalText;
            btn.disabled = false;
          }
        }
      } else {
        // Modo manual (sem gateway configurado)
        console.log('‚ö†Ô∏è Gateway n√£o configurado, usando modo manual');
        window.location.href = `pagamento.html?total=R$ ${totalFormatted}&shipping=${shipping}&qty=${qty}`;
      }
    }

    // CEP validation and auto-fill
    const cepInput = document.getElementById('cep');
    const cepError = document.getElementById('cep-error');
    const cepLoading = document.getElementById('cep-loading');
    const enderecoInput = document.getElementById('endereco');
    const bairroInput = document.getElementById('bairro');
    const cidadeInput = document.getElementById('cidade');
    const estadoInput = document.getElementById('estado');

    // Format CEP as user types
    cepInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 5) {
        value = value.slice(0, 5) + '-' + value.slice(5, 8);
      }
      e.target.value = value;
    });

    // Search address when CEP is complete
    cepInput.addEventListener('blur', async function() {
      const cep = this.value.replace(/\D/g, '');
      
      // Reset states
      cepError.classList.remove('show');
      cepLoading.classList.remove('show');
      this.classList.remove('error', 'success');
      
      if (cep.length !== 8) {
        if (cep.length > 0) {
          this.classList.add('error');
          cepError.classList.add('show');
        }
        return;
      }

      // Show loading
      cepLoading.classList.add('show');
      
      try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        cepLoading.classList.remove('show');
        
        if (data.erro) {
          this.classList.add('error');
          cepError.classList.add('show');
          return;
        }
        
        // Success - fill address fields
        this.classList.add('success');
        enderecoInput.value = data.logradouro || '';
        bairroInput.value = data.bairro || '';
        cidadeInput.value = data.localidade || '';
        estadoInput.value = data.uf || '';
        
        // Disable filled fields
        if (data.logradouro) enderecoInput.disabled = true;
        if (data.bairro) bairroInput.disabled = true;
        if (data.localidade) cidadeInput.disabled = true;
        if (data.uf) estadoInput.disabled = true;
        
        // Focus on number field
        document.getElementById('numero').focus();
        
      } catch (error) {
        cepLoading.classList.remove('show');
        this.classList.add('error');
        cepError.textContent = 'Erro ao buscar CEP';
        cepError.classList.add('show');
      }
    });

    // Allow editing disabled fields if user clicks on them
    [enderecoInput, bairroInput, cidadeInput, estadoInput].forEach(input => {
      input.addEventListener('click', function() {
        if (this.disabled) {
          this.disabled = false;
          this.focus();
        }
      });
    });
  </script>
  
  <!-- Payment Gateway Integration -->
  <script src="js/payment-gateway.js?v=1731020400"></script>
</body>
</html>
